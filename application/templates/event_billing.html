{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block page_content %}
<div class="row">
    <div class="col-sm-12">

    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_details', event_id=event.id) }}">Übersicht</a>
      </li>
    {% if current_user.is_authenticated %}
       {% if current_user.has_right('guide') or current_user.participate_event(event.id) %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_participants', event_id=event.id) }}">Teilnehmerliste</a>
      </li>
      {% endif %}
      {% if current_user.has_right('guide') %}

      <li class="nav-item">
        <a class="nav-link active" href="{{ url_for('EVENTS.page_billing', event_id=event.id) }}">Abrechnung</a>
      </li>
      {% endif %}
    {% if current_user.has_right('guide') or current_user.participate_event(event.id) %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_mybooking', event_id=event.id) }}">Meine Buchung</a>
      </li>
    {% endif %}
      {% if current_user.has_right('guide') %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_admin', event_id=event.id) }}">Bearbeiten</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_create', event_id=event.id) }}">Klonen</a>
      </li>
      {% endif %}
    {% endif %}
    </ul>
    </div>
</div>

<div class="row">
    <h1>{{event.event_name}} ({{event.start_date.strftime("%d.%m.%Y") }})</h1>
</div>

{% for owner, tickets_by_status in bookings.items() %}
      <div class="card">
        <div class="card-header" id="heading_{{loop.index}}">
          {% set user_id = tickets_by_status['paid'][0].ticket_info.bucher_user_id if tickets_by_status['paid'] else tickets_by_status['unpaid'][0].ticket_info.bucher_user_id %}
          <span class="badge badge-pill badge-info">
          <a href="{{ url_for('EVENTS.page_mybooking', event_id=event.id, user_id=user_id) }}" style="text-decoration: none; color: inherit;">
            {{owner}}
          </a>
          </span>
          </h2>
        </div>

        <div class="card-body">
          Total offen: {{ tickets_by_status['total'] }}
          {% for booking_status in ['paid', 'unpaid'] %}
              {% if booking_status == 'unpaid' %}
                  <h3>Nicht bezahlt</h3><br>
              {% elif booking_status == 'paid' %}
                  <h3>Bezahlt</h3>
              {% endif %}
              {% if booking_status == 'paid' %}
              <table class="table table-bordered" style="opacity: 0.6; color: #666;">
              {% else %}
              <table class="table table-bordered">
              {% endif %}
                <thead>
                  <tr>
                    <th scope="col">Teilnehmer</th>
                    <th scope="col">Was</th>
                    <th scope="col">Vereinsrolle</th>
                    <th scope="col">Alter</th>
                    <th scope="col">Preis Euro</th>
                    <th scope="col">Optionen</th>
                  </tr>
                </thead>
                <tbody>
                {% for ticket in tickets_by_status[booking_status] %}
                  {% if ticket.price != 0 %}
                  <tr>
                   <td>{{ ticket.ticket_owner }}</td>
                   <td>{{ ticket.ticket_info.name }}</td>
                    <td>{{ ticket.ticket_info.role }}</td>
                    <td>{{ age(ticket.ticket_info.birthdate) }}</td>
                    <td>
                      <span class="editable-price" 
                            data-ticket-id="{{ ticket.id }}" 
                            data-original-price="{{ ticket.price }}"
                            style="cursor: pointer; text-decoration: underline;" 
                            title="Preis bearbeiten (klicken)">
                        {{ ticket.price }}€
                      </span>
                    </td>
                    <td>
                      {% if booking_status != 'paid' %}
                      <a href="#" class="job btn btn-sm btn-outline-success me-1" 
                         data-job="paid" 
                         data-ticket_id={{ ticket.id }}
                         title="Als bezahlt markieren">
                        <i class="fas fa-check"></i>
                      </a>
                      {% endif %}
                      {% if booking_status != 'unpaid' %}
                      <a href="#" class="job btn btn-sm btn-outline-warning me-1" 
                         data-job="unpaid" 
                         data-ticket_id={{ ticket.id }}
                         title="Als unbezahlt markieren">
                        <i class="fas fa-times"></i>
                      </a>
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                {% endfor %}
                </tbody>
              </table>
              {% endfor %}
        </div>
    </ div>
{% endfor %}

{% endblock %}

{% block scripts %}
{{super()}}

{% if current_user.has_right('guide') %}
<script type="text/javascript">
$(document).ready(function() {
    $('.job').click(function(e) {
        e.preventDefault();
        var self_data = $(this);
        var data = {
            'ticket_id': self_data.data('ticket_id'),
            'job': self_data.data('job'),
            'event_id': '{{ event.id }}',
        }
        $.post('/event/change_paidstatus', data, function(res) {
            console.log(res);
            location.reload();
        });
    })
    
    // Handle price editing
    $('.editable-price').on('click', function(e){
        e.preventDefault();
        var $this = $(this);
        var ticketId = $this.data('ticket-id');
        var originalPrice = $this.data('original-price');
        
        var newPrice = prompt('Neuer Preis für dieses Ticket:', originalPrice);
        
        if (newPrice !== null && newPrice !== '' && !isNaN(newPrice)) {
            var data = {
                'ticket_id': ticketId,
                'new_price': parseFloat(newPrice),
                'event_id': '{{ event.id }}'
            };
            
            $.post('/event/change_price', data, function(res){
                if(res.success) {
                    $this.text(res.new_price + '€');
                    $this.data('original-price', res.new_price);
                    // Reload page to update totals
                    location.reload();
                } else {
                    alert('Fehler beim Ändern des Preises: ' + (res.message || 'Unbekannter Fehler'));
                }
            }).fail(function() {
                alert('Fehler beim Ändern des Preises. Bitte versuchen Sie es erneut.');
            });
        } else if (newPrice !== null) {
            alert('Bitte geben Sie einen gültigen Preis ein.');
        }
    });
});
</script>
{% endif %}
{% endblock %}
