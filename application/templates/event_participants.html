{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block page_content %}
<div class="row">
    <div class="col-sm-12">

    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_details', event_id=event.id) }}">Übersicht</a>
      </li>
    {% if current_user.is_authenticated %}
        {% if current_user.has_right('guide') or current_user.participate_event(event.id) %}
          <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('EVENTS.page_participants', event_id=event.id) }}">Teilnehmerliste</a>
          </li>
          {% if current_user.has_right('guide') %}
            {% set ns = namespace(has_paid_tickets=false) %}
            {% for ticket in event.tickets %}
              {% if ticket.price and ticket.price > 0 %}
                {% set ns.has_paid_tickets = true %}
              {% endif %}
            {% endfor %}
            {% if ns.has_paid_tickets %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('EVENTS.page_billing', event_id=event.id) }}">Abrechnung</a>
            </li>
            {% endif %}
          {% endif %}
      {% endif %}
    {% if current_user.has_right('guide') or current_user.participate_event(event.id) %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_mybooking', event_id=event.id) }}">Meine Buchung</a>
      </li>
    {% endif %}
      {% if current_user.has_right('guide') %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_admin', event_id=event.id) }}">Bearbeiten</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_create', event_id=event.id) }}">Klonen</a>
      </li>
      {% endif %}
    {% endif %}
    </ul>
    </div>
</div>

<div class="row">
    <h1>{{event.event_name}} ({{event.start_date.strftime("%d.%m.%Y") }})</h1>
</div>

<div class="row">
{% if bookings['confirmed'] %}
    <a type="button" class="btn btn-secondary" href="{{ url_for('EVENTS.page_participants_export', event_id=event.id) }}">Export CSV</a>&nbsp;
    <a type="button" class="btn btn-secondary" href="mailto:{{ ";".join(emails) }}?subject={{ event.event_name }}">Mail an Teilnehmer</a>
{% else %}
Keine Teilnehmer für Export oder Mail bestätigt
{% endif %}
</div>
{% if current_user.has_right('guide') %}
<hr>
{% if extra_tickets %}
<div class="row">
    <div class="col-sm-12">
        <h3>Kategorien</h3>
        <div class="mb-3">
            <button type="button" id="showAllCategories" class="btn btn-sm btn-info" style="display: none;" title="Alle anzeigen">
                <i class="fas fa-eye"></i> Alle anzeigen
            </button>
            <button type="button" id="hideAllCategories" class="btn btn-sm btn-warning" title="Alle verstecken">
                <i class="fas fa-eye-slash"></i> Alle verstecken
            </button>
        </div>
        <ul class="list-group">
        {% for ticket_group in extra_tickets.keys() %}
            <li id="{{ ticket_group|replace(' ', '_')}}_entry" class="list-group-item d-flex justify-content-between align-items-center category-item" data-category="{{ ticket_group }}">
                <a href="{{ url_for('EVENTS.page_extra_tickets', event_id=event.id, category=ticket_group) }}" class="text-decoration-none">
                    <strong>{{ ticket_group }}</strong>
                </a>
                <div>
                    <span class="badge badge-primary badge-pill">{{ extra_tickets[ticket_group]|length }}</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary hide-category-btn" data-category="{{ ticket_group }}" title="Verstecken">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success show-category-btn" data-category="{{ ticket_group }}" style="display: none;" title="Anzeigen">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </li>
        {% endfor %}
        </ul>
    </div>
</div>
<hr>
{% endif %}
{% endif %}

<div class="row">
{% for booking_type in ['confirmed', 'unconfirmed', 'waitinglist'] %}
    {% if booking_type == 'confirmed' %}
        <h2>Bestätigte Teilnehmer</h2><br>
    {% elif booking_type == 'waitinglist' %}
        <h2>Teilnehmer auf Warteliste</h2>
    {% elif booking_type == 'unconfirmed' %}
        <h2>Unbestätigte Teilnehmer</h2>
    {% endif %}
    <table class="table table-bordered">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Teilnehmer</th>
          <th scope="col">Ticket</th>
          <th scope="col">Account</th>
          <th scope="col">Telefonnummer</th>
          <th scope="col">E-Mail Adressse</th>
        {% if current_user.has_right('guide') %}
          <th scope="col">Medien Optin</th>
          <th scope="col">Vereinsrolle</th>
          <th scope="col">Alter</th>
          <th scope="col">Extra Fragen</th>
          <th scope="col">Teilnehmer Kommentar</th>
          <th scope="col">Guide Kommentar</th>
          <th scope="col">Buchung</th>
          <th scope="col">Optionen</th>
        {% endif %}
        </tr>
      </thead>
      <tbody>
      {% for ticket in bookings[booking_type] if not ticket.is_extra_ticket%}
        <tr>
        <td>{{ loop.index }}</td>
         <td>{{ ticket.ticket_owner }}
         </td>
         <td>{{ ticket.ticket_info.name }}</td>
         <td>
          {% if current_user.has_right('guide') %}
          <a href="{{ url_for('EVENTS.page_mybooking', event_id=event.id, user_id=ticket.ticket_info.bucher_user_id) }}" class="badge badge-pill badge-info" style="text-decoration: none;">{{ticket.ticket_info.bucher }}</a>
          {% else %}
          <span class="badge badge-pill badge-info">{{ticket.ticket_info.bucher }}</span>
          {% endif %}
         </td>
         <td>
            {% if ticket.ticket_info.data_optin or current_user.has_right('guide')%}{{ticket.ticket_info.telefon}}
            {%else%} versteckt {% endif %}
        </td>
        <td>{% if ticket.ticket_info.data_optin or current_user.has_right('guide')%}
            <a href="mailto:{{ticket.ticket_info.email}}">{{ticket.ticket_info.email}}</a>
            {%else%} versteckt {% endif %}
        </td>
        {% if current_user.has_right('guide') %}
          <td>{{ translate_bool(ticket.ticket_info.media_optin) }}</td>
          <td>{{ ticket.ticket_info.role }}</td>
          <td>{{ age(ticket.ticket_info.birthdate) }}</td>
          <td>
            <table>
            {% for field in ticket.extra_questions %}
                <tr>
                 <th>{{ field[0] }}</th>
                 <td>{{ field[1] }}</td>
                </tr>
            {% endfor %}
            </table>
          </td>
          <td>{{ ticket.ticket_info.comment}}</td>
          <td>
            <input type="text" class="form-control guide-comment-input" 
                   data-ticket-id="{{ ticket.id }}" 
                   value="{{ ticket.ticket_info.guide_comment }}" 
                   placeholder="Guide Kommentar..." 
                   style="min-width: 150px;">
          </td>
          <td>{{ticket.booking_date.strftime('%d.%m.%Y %H:%M')}}</td>
          <td>
            {% if booking_type != 'confirmed' %}
            <a href="#" class="job" data-job="confirm" data-ticket_id={{ ticket.id }}>Bestätigen</a></span>
            {% endif %}
            {% if booking_type != 'waitinglist' %}
            <a href="#" class="job" data-job="waitlist" data-ticket_id={{ ticket.id }}>Warteliste</a>
            {% endif %}
            <a href="#" class="job" data-job="delete" data-ticket_id={{ ticket.id }}>Löschen</a>
          </td>
        {% endif %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
{% endfor %}
</div>

{% if current_user.has_right('guide') and extra_tickets %}
<div class="row">
<h1>Kategorien</h1>
</div>


{% for ticket_group, members in extra_tickets.items() %}
<div class="row extra-ticket-table" data-category="{{ ticket_group }}">
    <h2>{{ ticket_group }}</h2>
</div>
    <table class="table table-bordered extra-ticket-table" data-category="{{ ticket_group }}">
      <thead>
        <tr>
          <th scope="col">#</td>
            <th scope="col" style="width: 200px;">Teilnehmer</th>
          <th scope="col" style="width: 300px;">Teilnehmer Kommentar</th>
          <th scope="col" style="width: 300px;">Guide Kommentar</th>
          <th scope="col">Jahrgang</th>
          <th scope="col">Bezahlt</th>
          <th scope="col">Account</th>
          <th scope="col">Optionen</th>
        </tr>
      </thead>
      <tbody>
    {% for ticket_id, owner, comment, guide_comment, birthdate, is_paid, bucher, bucher_user_id in members %}
        <tr>
        <td>{{ loop.index }}</td>
         <td>{{ owner }}</td>
         <td>{{ comment }}</td>
         <td>
            <input type="text" class="form-control guide-comment-input" 
                   data-ticket-id="{{ ticket_id }}" 
                   value="{{ guide_comment or '' }}" 
                   placeholder="Guide Kommentar..." 
                   style="min-width: 150px;">
          </td>
         <td>{{ birthdate.strftime("%m/%Y") if birthdate else "" }}</td>
         <td>
           {% if is_paid %}
           <span class="badge badge-success">Ja</span>
           {% else %}
           <span class="badge badge-danger">Nein</span>
           {% endif %}
         </td>
         <td>
          {% if current_user.has_right('guide') %}
          <a href="{{ url_for('EVENTS.page_mybooking', event_id=event.id, user_id=bucher_user_id) }}" class="badge badge-pill badge-info" style="text-decoration: none;">{{ bucher }}</a>
          {% else %}
          <span class="badge badge-pill badge-info">{{ bucher }}</span>
          {% endif %}
         </td>
         <td>
            <a href="#" class="job" data-job="delete" data-ticket_id={{ ticket_id }}>Löschen</a>
         </td>
        </tr>
    {% endfor %}
      </tbody>
    </table>
{% endfor %}
{% endif %}

{% endblock %}

{% block scripts %}
{{super()}}

{% if current_user.has_right('guide') %}
<script type="text/javascript">
$(document).ready(function() {
    var hiddenCategories = new Set();
    
    // Load hidden categories from database on page load
    $.get('/event/get_hidden_categories', {'event_id': '{{ event.id }}'}, function(res) {
        if (res.success && res.hidden_categories) {
            res.hidden_categories.forEach(function(category) {
                hiddenCategories.add(category);
                // Hide the category
                var elementId = category.replace(/\s+/g, '_') + '_entry';
                $('#' + elementId).css({
                    'display': 'none',
                    'visibility': 'hidden',
                    'height': '0',
                    'padding': '0',
                    'margin': '0',
                    'border': 'none',
                    'overflow': 'hidden'
                });
                $('.extra-ticket-table[data-category="' + category + '"]').hide();
            });
            updateGlobalButtons();
        }
    });
    
    $('.job').click(function(e) {
        e.preventDefault();
        var self_data = $(this);
        var data = {
            'ticket_id': self_data.data('ticket_id'),
            'job': self_data.data('job'),
            'event_id': '{{ event.id }}',
        }
        $.post('/event/change_participants', data, function(res) {
            console.log(res);
            location.reload();
        });
    })
    
    // Hide Category Button
    $('.hide-category-btn').click(function(e) {
        e.preventDefault();
        var category = $(this).data('category');
        hiddenCategories.add(category);
        
        // Hide the ticket group entry by ID (handle spaces) and corresponding tables
        var elementId = category.replace(/\s+/g, '_') + '_entry';
        $('#' + elementId).css({
            'display': 'none',
            'visibility': 'hidden',
            'height': '0',
            'padding': '0',
            'margin': '0',
            'border': 'none',
            'overflow': 'hidden'
        });
        $('.extra-ticket-table[data-category="' + category + '"]').hide();
        
        // Save hidden state to database
        var data = {
            'action': 'hide_category',
            'category': category,
            'event_id': '{{ event.id }}'
        };
        $.post('/event/manage_hidden_categories', data, function(res) {
            console.log('Category hidden:', res);
        });
        
        // Update global buttons
        updateGlobalButtons();
    });
    
    // Show Category Button  
    $('.show-category-btn').click(function(e) {
        e.preventDefault();
        var category = $(this).data('category');
        hiddenCategories.delete(category);
        
        // Switch buttons: hide Show button, show Hide button
        $(this).hide();
        $(this).siblings('.hide-category-btn').show();
        
        // Show corresponding extra ticket tables
        $('.extra-ticket-table[data-category="' + category + '"]').show();
        
        // Save shown state to database
        var data = {
            'action': 'show_category',
            'category': category,
            'event_id': '{{ event.id }}'
        };
        $.post('/event/manage_hidden_categories', data, function(res) {
            console.log('Category shown:', res);
        });
        
        // Update global buttons
        updateGlobalButtons();
    });
    
    
    // Show All Categories Button
    $('#showAllCategories').click(function() {
        hiddenCategories.clear();
        
        // Show all category items and tables, reset buttons
        $('.category-item').css({
            'display': '',
            'visibility': '',
            'height': '',
            'padding': '',
            'margin': '',
            'border': '',
            'overflow': ''
        }).show();
        $('.extra-ticket-table').show();
        $('.hide-category-btn').show();
        $('.show-category-btn').hide();
        
        // Save show all state to database
        var data = {
            'action': 'show_all_categories',
            'event_id': '{{ event.id }}'
        };
        $.post('/event/manage_hidden_categories', data, function(res) {
            console.log('All categories shown:', res);
        });
        
        // Update global buttons
        updateGlobalButtons();
    });
    
    // Hide All Categories Button
    $('#hideAllCategories').click(function() {
        $('.category-item').each(function() {
            var category = $(this).data('category');
            hiddenCategories.add(category);
        });
        
        // Hide all category items and tables with robust CSS method
        $('.category-item').css({
            'display': 'none',
            'visibility': 'hidden',
            'height': '0',
            'padding': '0',
            'margin': '0',
            'border': 'none',
            'overflow': 'hidden'
        });
        $('.extra-ticket-table').hide();
        
        // Save hide all state to database
        var data = {
            'action': 'hide_all_categories',
            'event_id': '{{ event.id }}'
        };
        $.post('/event/manage_hidden_categories', data, function(res) {
            console.log('All categories hidden:', res);
        });
        
        // Update global buttons
        updateGlobalButtons();
    });
    
    function updateGlobalButtons() {
        var totalCategories = $('.category-item').length;
        var hiddenCount = hiddenCategories.size;
        
        if (hiddenCount === 0) {
            $('#showAllCategories').hide();
            $('#hideAllCategories').show();
        } else if (hiddenCount === totalCategories) {
            $('#showAllCategories').show();
            $('#hideAllCategories').hide();
        } else {
            $('#showAllCategories').show();
            $('#hideAllCategories').show();
        }
    }
    
    // Guide Comment Update
    $('.guide-comment-input').on('blur', function() {
        var input = $(this);
        var ticket_id = input.data('ticket-id');
        var guide_comment = input.val();
        
        var data = {
            'ticket_id': ticket_id,
            'job': 'update_guide_comment',
            'guide_comment': guide_comment,
            'event_id': '{{ event.id }}'
        };
        
        input.addClass('saving');
        input.prop('disabled', true);
        
        $.post('/event/change_participants', data, function(res) {
            input.removeClass('saving');
            input.prop('disabled', false);
            if (res.success) {
                input.css('background-color', '#d4edda');
                setTimeout(function() {
                    input.css('background-color', '');
                }, 1000);
            } else {
                input.css('background-color', '#f8d7da');
                setTimeout(function() {
                    input.css('background-color', '');
                }, 1000);
            }
        }).fail(function() {
            input.removeClass('saving');
            input.prop('disabled', false);
            input.css('background-color', '#f8d7da');
            setTimeout(function() {
                input.css('background-color', '');
            }, 1000);
        });
    });
    
    // Enter key saves the comment
    $('.guide-comment-input').on('keypress', function(e) {
        if (e.which === 13) {
            $(this).blur();
        }
    });
});
</script>
{% endif %}
{% endblock %}
