{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block page_content %}
<div class="row">
    <div class="col-sm-12">

    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_details', event_id=event.id) }}">Übersicht</a>
      </li>
    {% if current_user.is_authenticated %}
       {% if current_user.has_right('guide') or current_user.participate_event(event.id) %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_participants', event_id=event.id) }}">Teilnehmerliste</a>
      </li>
      {% if current_user.has_right('guide') %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_billing', event_id=event.id) }}">Abrechnung</a>
      </li>
      {% endif %}
      {% endif %}
    {% if current_user.has_right('guide') or current_user.participate_event(event.id) %}
      <li class="nav-item">
        <a class="nav-link active" href="{{ url_for('EVENTS.page_mybooking', event_id=event.id) }}">
          {% if is_viewing_other_user %}Buchung von {{ target_user.first_name }} {{ target_user.last_name }}{% else %}Meine Buchung{% endif %}
        </a>
      </li>
    {% endif %}
      {% if current_user.has_right('guide') %}
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_admin', event_id=event.id) }}">Bearbeiten</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('EVENTS.page_create', event_id=event.id) }}">Klonen</a>
      </li>
      {% endif %}
    {% endif %}
    </ul>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">
    <h1>{{event.event_name}}</h1>
    {% if is_viewing_other_user %}
    <div class="alert alert-warning" role="alert">
        <strong>Guide-Ansicht:</strong> Du betrachtest die Buchung von {{ target_user.first_name }} {{ target_user.last_name }}.
    </div>
    {% endif %}
    </div>
</div>


{% if not is_viewing_other_user %}
<div class="alert alert-primary" role="alert">
    Bitte passe bei Mehrfachanmeldung die Ticketfelder Name, E-Mail und Handynummer für alle hinzugefügten Personen an, damit dem Guide eine komplette Teilnehmerliste zur Verfügung steht.
</div>
{% endif %}

{% if current_user.has_right('guide') %}
<div class="row">
    <div class="col-sm-12">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addNewTicket">
            <i class="fas fa-plus"></i> Neues Ticket für {{ target_user.first_name }} {{ target_user.last_name }} hinzufügen
        </button>
    </div>
</div>
<br>
{% endif %}

{% if total_cost %}
<div class="row">
    <div class="col-sm-12">
        <div class="alert alert-info" role="alert">
            <strong>Kosten: {{open_cost}}/ {{ total_cost }}€</strong>

        </div>
    </div>
</div>
{% endif %}

<div class="row">
<table class="table table-hover">
  <thead>
    <tr>
      <th></th>
      <th scope="col">Name</th>
      <th scope="col">E-Mail</th>
      <th scope="col">Handy</th>
      <th scope="col">Alter</th>
      <th scope="col">Kommentar</th>
      <th scope="col">Guide</th>
      <th scope="col">Teilnahme Bestätigt?</th>
      <th scope="col">Auf Warteliste?</th>
      <th scope="col">Buchungszeit</th>
      <th scope="col">Preis</th>
      <th scope="col">Bezahlt</th>
      {% if current_user.has_right('guide') %}
      <th scope="col">Aktionen</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>

  {% for ticket_name, tickets in tickets_by_name.items() %}
  <tr>
      <th colspan="{% if current_user.has_right('guide') %}11{% else %}10{% endif %}">{{ticket_name}}</th>
  </tr>
    {% for ticket in tickets %}
      <tr>
        <td>
          {% if current_user.has_right('guide') or target_user == current_user %}
          <a class="far fa-edit" 
               data-ticket-id="{{ ticket.ticket_id }}"
               data-name="{{ticket.name_on_ticket}}"
               data-email="{{ticket.email_on_ticket}}"
               data-phone="{{ticket.phone_on_ticket}}"
               data-birthdate="{{ticket.birthdate_on_ticket}}"
               data-comment="{{ticket.comment_on_ticket }}"
               data-toggle="modal" data-target="#editName"
               href='#' title="Daten ändern"></a>
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td><span id="user_name_{{ticket.ticket_id}}">{{ticket.name_on_ticket}}</span></td>
        <td><span id="user_email_{{ticket.ticket_id}}">{{ticket.email_on_ticket}}</span></td>
        <td><span id="user_phone_{{ticket.ticket_id}}">{{ticket.phone_on_ticket}}</span></td>
        <td><span id="user_age{{ticket.ticket_id}}">{{age(ticket.birthdate_on_ticket)}}</span></td>
        <td><span id="user_comment{{ticket.ticket_id}}">{{ticket.comment_on_ticket}}</span></td>
        <td><span id="user_guide{{ticket.ticket_id}}">{{ticket.guide or "-"}}</span></td>
        <td>
          {% if not ticket.is_extra_ticket %}
            {% if ticket.confirmed %}
              <span class="badge badge-success">{{translate_bool(ticket.confirmed)}}</span>
            {% else %}
              <span class="badge badge-danger">{{translate_bool(ticket.confirmed)}}</span>
            {% endif %}
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>
          {% if not ticket.is_extra_ticket %}
            {% if ticket.waitinglist %}
              <span class="badge badge-danger">{{translate_bool(ticket.waitinglist)}}</span>
            {% else %}
              <span class="badge badge-success">{{translate_bool(ticket.waitinglist)}}</span>
            {% endif %}
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>{{ticket.booking_date.strftime('%d.%m.%Y %H:%M')}}</td>
        <td>
        {% if current_user.has_right('guide') %}
          <span class="editable-price" 
                data-ticket-id="{{ ticket.ticket_id }}" 
                data-original-price="{{ ticket.price }}"
                style="cursor: pointer; text-decoration: underline;" 
                title="Preis bearbeiten (klicken)">
            {{ ticket.price }}€
          </span>
        {% else %}
          {{ ticket.price }}€
        {% endif %}
        </td>
        <td>
          {% if ticket.is_paid %}
          <span class="badge badge-success">Ja</span>
          {% else %}
          <span class="badge badge-danger">Nein</span>
          {% endif %}
         </td>
         {% if current_user.has_right('guide') %}
         <td>
            <a href="#" class="job btn btn-sm btn-outline-danger" 
               data-job="delete"
               data-ticket_id="{{ ticket.ticket_id }}"
               title="Ticket löschen">
              <i class="fas fa-trash"></i>
            </a>
         </td>
         {% endif %}
            </tr>
     {% endfor %}
  {% endfor %}
  </tbody>
</table>
</div>

<div class="modal" tabindex="-1" role="dialog" id="editName">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Teilnehmer anpassen</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <form id="change_form" method="GET" autocomplete="off">
      <!-- Hidden dummy fields to confuse Firefox autofill -->
      <input type="text" style="display: none;">
      <input type="password" style="display: none;">
      <div class="position-relative">
        <input id="new_name" name="new_name" class="form-control" placeholder="Name des Teilnehmers" autocomplete="nope">
        <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 200px; overflow-y: auto;"></div>
      </div>
      <br>
      <input id="new_phone" name="new_phone" class="form-control" placeholder="Handynummer" autocomplete="new-password">
      <input id="new_email" name="new_email" class="form-control" placeholder="E-Mail Adresse" autocomplete="new-password">
      <input id="new_birthdate" name="new_birthdate" class="form-control" type="date" placeholder="Geburtsdatum" autocomplete="new-password">
      <textarea id="new_comment" name="new_comment" class="form-control" type="text" placeholder="Kommentar" autocomplete="off"></textarea>
      <input id="ticket_id" name="ticket_id" type="hidden" class="form-control">
      <input id="event_id" name="event_id" type="hidden" class="form-control" value="{{event.id}}">
      <input id="target_user_id" name="target_user_id" type="hidden" class="form-control" value="{{target_user.id}}">>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Neuen Daten speichern</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal for adding new ticket (Guide only) -->
{% if current_user.has_right('guide') %}
<div class="modal" tabindex="-1" role="dialog" id="addNewTicket">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Neues Ticket für {{ target_user.first_name }} {{ target_user.last_name }} hinzufügen</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <form id="add_ticket_form" method="POST" autocomplete="off">
        <div class="form-group">
          <label for="ticket_type">Ticket-Typ</label>
          <select id="ticket_type" name="ticket_type" class="form-control" required>
            <option value="">Bitte auswählen...</option>
            {% for ticket in event.tickets %}
            <option value="{{ticket.name}}">{{ticket.name}} ({{ticket.price}}€)</option>
            {% endfor %}
          </select>
        </div>
        <div class="position-relative">
          <input id="add_new_name" name="new_name" class="form-control" placeholder="Name des Teilnehmers" autocomplete="nope" required>
          <div id="add_suggestions" class="list-group position-absolute w-100" style="z-index: 1050; display: none; max-height: 200px; overflow-y: auto;"></div>
        </div>
        <br>
        <input id="add_new_phone" name="new_phone" class="form-control" placeholder="Handynummer" autocomplete="new-password">
        <input id="add_new_email" name="new_email" class="form-control" placeholder="E-Mail Adresse" autocomplete="new-password">
        <input id="add_new_birthdate" name="new_birthdate" class="form-control" type="date" placeholder="Geburtsdatum" autocomplete="new-password">
        <textarea id="add_new_comment" name="new_comment" class="form-control" type="text" placeholder="Kommentar" autocomplete="off"></textarea>
        <input id="add_event_id" name="event_id" type="hidden" class="form-control" value="{{event.id}}">
        <input id="add_user_id" name="user_id" type="hidden" class="form-control" value="{{target_user.id}}">
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Ticket hinzufügen</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
      </div>
      </form>
    </div>
  </div>
</div>
{% endif %}



{% endblock %}

{% block scripts %}
    {{super()}}
    <script>
    $(document).ready(function() {
        var modal = $('#editName');
        var addModal = $('#addNewTicket');
        var suggestionsDiv = $('#suggestions');
        var addSuggestionsDiv = $('#add_suggestions');
        var nameInput = $('#new_name');
        var addNameInput = $('#add_new_name');

        // Handle name input for suggestions (both modals)
        function handleNameInput(input, suggDiv) {
            input.on('input', function() {
                var query = $(this).val().toLowerCase();
                
                if (query.length < 2) {
                    suggDiv.hide();
                    return;
                }

                // Make API call with current query
                var eventId = $('#event_id').val() || $('#add_event_id').val();
                var targetUserId = $('#target_user_id').val() || $('#add_user_id').val();
                if (eventId) {
                    var requestData = { q: query };
                    if (targetUserId) {
                        requestData.target_user_id = targetUserId;
                    }
                    
                    $.get('/user/get_data/' + eventId, requestData)
                        .done(function(data) {
                            displaySuggestions(data, suggDiv, input);
                        })
                        .fail(function() {
                            console.error('Failed to load user data from API');
                            suggDiv.hide();
                        });
                }
            });
        }

        handleNameInput(nameInput, suggestionsDiv);
        handleNameInput(addNameInput, addSuggestionsDiv);

        // Hide suggestions when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('#new_name, #suggestions, #add_new_name, #add_suggestions').length) {
                suggestionsDiv.hide();
                addSuggestionsDiv.hide();
            }
        });

        // Display suggestions (updated to handle both modals)
        function displaySuggestions(suggestions, suggDiv, targetInput) {
            suggDiv.empty();
            
            if (suggestions.length === 0) {
                suggDiv.hide();
                return;
            }

            suggestions.forEach(function(person) {
                var suggestionItem = $('<a href="#" class="list-group-item list-group-item-action">')
                    .text(person.name)
                    .data('person', person);
                
                suggestionItem.on('click', function(e) {
                    e.preventDefault();
                    fillFormWithPersonData($(this).data('person'), targetInput);
                    suggDiv.hide();
                });

                suggDiv.append(suggestionItem);
            });

            suggDiv.show();
        }

        // Fill form with selected person data (updated for both modals)
        function fillFormWithPersonData(person, targetInput) {
            var isAddModal = targetInput.attr('id') === 'add_new_name';
            var prefix = isAddModal ? 'add_' : '';
            
            $('#' + prefix + 'new_name').val(person.name);
            $('#' + prefix + 'new_email').val(person.email);
            $('#' + prefix + 'new_phone').val(person.phone);
            $('#' + prefix + 'new_birthdate').val(person.birthdate);
        }

        modal.on('show.bs.modal', function(e){
            var name = $(e.relatedTarget).data('name');
            var email = $(e.relatedTarget).data('email');
            var phone = $(e.relatedTarget).data('phone');
            var birthdate = $(e.relatedTarget).data('birthdate');
            var comment = $(e.relatedTarget).data('comment');
            var ticket_id = $(e.relatedTarget).data('ticket-id');
            $('#new_name').val(name);
            $('#new_email').val(email);
            $('#new_phone').val(phone);
            $('#new_birthdate').val(birthdate);
            $('#new_comment').val(comment);
            $('#ticket_id').val(ticket_id);
            // Hide suggestions when modal opens
            suggestionsDiv.hide();
            addSuggestionsDiv.hide();
        });

        // Handle add ticket form submission
        $('#add_ticket_form').on('submit', function(e){
            e.preventDefault();
            var form = $(this).serialize();
            
            $.post('/user/add_ticket', form, function(res){
                if(res.success) {
                    // Reload the page to show the new ticket
                    location.reload();
                } else {
                    alert('Fehler beim Hinzufügen des Tickets: ' + (res.message || 'Unbekannter Fehler'));
                }
            }).fail(function() {
                alert('Fehler beim Hinzufügen des Tickets. Bitte versuchen Sie es erneut.');
            });
        });

        // Handle delete ticket functionality (using existing system)
        $('.job').on('click', function(e){
            e.preventDefault();
            var self_data = $(this);
            var job = self_data.data('job');
            
            if(job === 'delete') {
                var ticketId = self_data.data('ticket_id');
                
                if(confirm('Soll das Ticket wirklich gelöscht werden?')) {
                    var data = {
                        'ticket_id': ticketId,
                        'job': job,
                        'event_id': '{{event.id}}'
                    };
                    
                    $.post('/event/change_participants', data, function(res){
                        console.log(res);
                        location.reload();
                    }).fail(function() {
                        alert('Fehler beim Löschen des Tickets. Bitte versuchen Sie es erneut.');
                    });
                }
            }
        });

        $('#change_form').on('submit', function(e){
            e.preventDefault();
            var raw = $('#change_form');
            var form = raw.serialize();
            var data_array = raw.serializeArray();
            var data = {}
            $.each(data_array, function(){
                data[this.name] = this.value;
            });
            $.post('/user/change_ticket', form, function(res){
                $('#user_name_'+data.ticket_id).html(data.new_name);
                $('#user_email_'+data.ticket_id).html(data.new_email);
                $('#user_phone_'+data.ticket_id).html(data.new_phone);
                $('#user_age'+data.ticket_id).html(data.new_birthdate);
                $('#user_comment'+data.ticket_id).html(data.new_comment);
                modal.modal('hide');
            });
        });

        // Handle price editing for guides
        $('.editable-price').on('click', function(e){
            e.preventDefault();
            var $this = $(this);
            var ticketId = $this.data('ticket-id');
            var originalPrice = $this.data('original-price');
            
            var newPrice = prompt('Neuer Preis für dieses Ticket:', originalPrice);
            
            if (newPrice !== null && newPrice !== '' && !isNaN(newPrice)) {
                var data = {
                    'ticket_id': ticketId,
                    'new_price': parseFloat(newPrice),
                    'event_id': '{{event.id}}'
                };
                
                $.post('/event/change_price', data, function(res){
                    if(res.success) {
                        $this.text(res.new_price + '€');
                        $this.data('original-price', res.new_price);
                        // Reload page to update totals
                        location.reload();
                    } else {
                        alert('Fehler beim Ändern des Preises: ' + (res.message || 'Unbekannter Fehler'));
                    }
                }).fail(function() {
                    alert('Fehler beim Ändern des Preises. Bitte versuchen Sie es erneut.');
                });
            } else if (newPrice !== null) {
                alert('Bitte geben Sie einen gültigen Preis ein.');
            }
        });
    });

    </script>
{% endblock %}
